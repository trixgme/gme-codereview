# GME 자동 코드 리뷰 시스템 가이드

## 목차
1. [프로젝트 개요](#프로젝트-개요)
2. [주요 기능](#주요-기능)
3. [시스템 구조](#시스템-구조)
4. [설치 가이드](#설치-가이드)
5. [환경 설정](#환경-설정)
6. [사용 방법](#사용-방법)
7. [개발자별 설정](#개발자별-설정)
8. [문제 해결](#문제-해결)
9. [API 엔드포인트](#api-엔드포인트)

---

## 프로젝트 개요

**GME 자동 코드 리뷰 시스템**은 Bitbucket 저장소의 커밋과 Pull Request에 대해 자동으로 코드 리뷰를 수행하는 AI 기반 시스템입니다.

### 핵심 특징
- **GPT-5 모델** 활용한 심층 코드 분석
- **다국어 지원** (한국어/영어)
- **Slack 알림** 통합
- **중복 리뷰 방지** 메커니즘
- **Vercel 배포** 지원

### 기술 스택
- **Backend**: Node.js, Express
- **AI**: OpenAI GPT-5
- **배포**: Vercel (Serverless)
- **통합**: Bitbucket API, Slack Webhook

---

## 주요 기능

### 1. 자동 코드 리뷰
- 커밋 푸시 시 자동 리뷰 생성
- Pull Request 생성/업데이트 시 리뷰
- 버그, 보안 취약점, 성능 문제 감지
- 코드 개선 제안

### 2. 개발자별 맞춤 설정
- **한국어 리뷰 지원 개발자**:
  - Eugene
  - fred
  - 한세희(Trix)
- 나머지 개발자는 영어 리뷰

### 3. Slack 통합
- 리뷰 완료 알림
- 작성자 정보 표시
- 리뷰 언어 표시
- Bitbucket 링크 제공

### 4. 지능형 필터링
- 설정 파일 자동 스킵
- 번역 파일 제외
- 생성된 파일 무시
- node_modules, dist 등 제외

---

## 시스템 구조

```
gme-codereview/
├── src/
│   ├── config/
│   │   ├── openai.js           # OpenAI API 설정
│   │   ├── repositories.js      # 저장소별 설정
│   │   └── developerConfigs.js  # 개발자별 언어 설정
│   ├── routes/
│   │   ├── webhook.js          # 메인 웹훅 처리
│   │   └── multiRepoWebhook.js # 다중 저장소 지원
│   ├── utils/
│   │   ├── codeReviewer.js     # GPT-5 리뷰 로직
│   │   ├── bitbucketClient.js  # Bitbucket API
│   │   ├── slackNotifier.js    # Slack 알림
│   │   ├── processedCommitsCache.js # 중복 방지
│   │   └── batchProcessor.js   # 타임아웃 보호
│   └── index.js                # Express 서버
├── .env                        # 환경 변수
├── vercel.json                 # Vercel 설정
└── package.json
```

---

## 설치 가이드

### 1. 저장소 클론
```bash
git clone https://github.com/yourusername/gme-codereview.git
cd gme-codereview
```

### 2. 의존성 설치
```bash
npm install
```

### 3. 환경 변수 설정
`.env` 파일 생성:
```env
# OpenAI API
OPENAI_API_KEY=your_openai_api_key

# Bitbucket
BITBUCKET_WORKSPACE=gmeremittance
BITBUCKET_USERNAME=your_username
BITBUCKET_APP_PASSWORD=your_app_password

# Slack
SLACK_WEBHOOK_URL=your_slack_webhook_url

# Server
PORT=3002
NODE_ENV=production

# Review Settings
MAX_FILES_PER_REVIEW=0
MAX_DIFF_SIZE=200000
MAX_OUTPUT_TOKENS_PER_FILE=32000
```

### 4. 로컬 실행
```bash
npm start
# 또는 개발 모드
npm run dev
```

---

## 환경 설정

### Bitbucket 웹훅 설정

1. Bitbucket 저장소 → Settings → Webhooks
2. 새 웹훅 추가:
   - **Name**: Code Review Bot
   - **URL**: `https://your-domain.vercel.app/webhook/bitbucket`
   - **Triggers**: 
     - Repository: Push
     - Pull Request: Created, Updated

### Slack 웹훅 설정

1. Slack 워크스페이스 → Apps → Incoming Webhooks
2. 새 웹훅 생성
3. 채널 선택
4. Webhook URL을 `.env`에 추가

### Vercel 배포

```bash
# Vercel CLI 설치
npm i -g vercel

# 배포
vercel

# 환경 변수 설정
vercel env add OPENAI_API_KEY
vercel env add BITBUCKET_WORKSPACE
# ... 기타 환경 변수
```

---

## 사용 방법

### 1. 커밋 리뷰
코드를 커밋하고 푸시하면 자동으로 리뷰가 생성됩니다:

```bash
git add .
git commit -m "feat: 새 기능 추가"
git push origin main
```

몇 초 후 Bitbucket에 리뷰 댓글이 추가됩니다.

### 2. Pull Request 리뷰
PR을 생성하거나 업데이트하면 자동으로 전체 PR에 대한 리뷰가 생성됩니다.

### 3. Slack 알림 확인
설정된 Slack 채널에서 리뷰 완료 알림을 확인할 수 있습니다:
- 작성자 이름
- 파일 수
- 리뷰 언어 (🇰🇷/🇺🇸)
- Bitbucket 링크

---

## 개발자별 설정

### 한국어 리뷰 추가하기

`src/config/developerConfigs.js` 파일 수정:

```javascript
developers: {
  '개발자이름': {
    reviewLanguage: 'ko',
    enableReview: true,
    notifyOnReview: true,
    preferences: {
      detailLevel: 'high',
      includeCodeExamples: true,
      focusAreas: ['버그', '보안', '성능', '코드 품질']
    }
  }
}
```

### 저장소별 설정

`src/config/repositories.js` 파일에서 저장소별 리뷰 설정 가능:

```javascript
'repository-name': {
  enabled: true,
  reviewTypes: ['bugs', 'security', 'performance'],
  skipPaths: ['node_modules/', 'dist/'],
  customPrompt: '특별한 리뷰 지침...'
}
```

---

## 문제 해결

### 1. 중복 리뷰 문제
**증상**: 하나의 커밋에 여러 개의 리뷰가 작성됨

**해결**: 
- 캐시 시스템이 정상 작동하는지 확인
- `processedCommitsCache.js`의 로그 확인
- 웹훅이 중복으로 등록되어 있는지 확인

### 2. Vercel 타임아웃
**증상**: 300초 타임아웃 에러

**해결**:
- 파일 수가 너무 많은 경우 `BatchProcessor` 활용
- 메모리 설정 확인 (최대 2048MB for Hobby)

### 3. 리뷰가 생성되지 않음
**확인 사항**:
- OpenAI API 키 유효성
- Bitbucket 인증 정보
- 웹훅 URL 정확성
- 로그 파일 확인 (`logs/errors.log`)

### 4. Slack 알림 미수신
**확인 사항**:
- Webhook URL 유효성
- 네트워크 연결
- Slack 채널 권한

---

## API 엔드포인트

### 메인 웹훅
```
POST /webhook/bitbucket
```
단일 저장소 웹훅 처리

### 다중 저장소 웹훅
```
POST /multi-repo/bitbucket/:workspace
```
여러 저장소 지원

### 헬스 체크
```
GET /health
```
서버 상태 확인

### 테스트 엔드포인트
```
POST /test/review
```
리뷰 기능 테스트

---

## 로그 및 모니터링

### 로그 파일 위치
- `logs/errors.log` - 에러 로그
- `logs/webhooks.log` - 웹훅 처리 로그
- `logs/api.log` - API 호출 로그

### 모니터링 메트릭
- 리뷰 생성 시간
- API 응답 시간
- 처리된 파일 수
- 캐시 히트율

---

## 보안 고려사항

1. **API 키 관리**
   - 환경 변수 사용
   - 절대 코드에 하드코딩 금지
   - 정기적 키 순환

2. **웹훅 검증**
   - Bitbucket 서명 검증
   - IP 화이트리스트

3. **Rate Limiting**
   - OpenAI API 제한 준수
   - 재시도 로직 구현

---

## 성능 최적화

### 현재 설정
- **파일당 최대 입력**: 200,000 문자
- **파일당 최대 출력**: 32,000 토큰
- **PR 요약 최대**: 16,000 토큰
- **배치 처리**: 3개 파일 동시
- **타임아웃**: 280초 (20초 버퍼)

### 최적화 팁
1. 불필요한 파일 필터링
2. 캐시 적극 활용
3. 병렬 처리 활용
4. 토큰 사용량 모니터링

---

## 업데이트 내역

### v2.0.0 (2024.08)
- GPT-5 모델 업그레이드
- 한국어 리뷰 지원 추가
- 중복 리뷰 방지 강화
- Slack 알림 개선

### v1.5.0
- 다중 저장소 지원
- 타임아웃 보호 추가
- 파일 필터링 개선

### v1.0.0
- 초기 릴리즈
- 기본 리뷰 기능
- Bitbucket 통합

---

## 지원 및 문의

- **이슈 리포트**: GitHub Issues
- **이메일**: support@gmeremit.com
- **Slack**: #code-review-bot 채널

---

## 라이선스

This project is proprietary and confidential.
© 2024 GME Remittance. All rights reserved.